<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro Builder - Visual Flow Editor</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/reactflow@11/dist/umd/index.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/reactflow@11/dist/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            overflow-y: auto;
        }

        .main-canvas {
            flex: 1;
            position: relative;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .node-palette {
            margin-bottom: 30px;
        }

        .palette-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .node-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .node-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .node-item:active {
            cursor: grabbing;
        }

        .node-icon {
            font-size: 20px;
        }

        .properties-panel {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .react-flow__node {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 2px solid transparent;
        }

        .react-flow__node.selected {
            border-color: #4CAF50;
        }

        .react-flow__handle {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .custom-node {
            background: white;
            border-radius: 8px;
            padding: 15px;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .node-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .node-content {
            font-size: 14px;
            color: #666;
        }

        .option-item {
            background: #f0f0f0;
            padding: 6px 10px;
            margin: 4px 0;
            border-radius: 4px;
            font-size: 12px;
        }

        .stats-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #333;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { ReactFlow, addEdge, useNodesState, useEdgesState, Controls, MiniMap, Background } = ReactFlow;

        // Componente de n√≥ customizado para mensagens
        const MessageNode = ({ data, id }) => {
            return (
                <div className="custom-node">
                    <div className="node-header">
                        <span className="node-icon">üí¨</span>
                        {data.label}
                    </div>
                    <div className="node-content">
                        {data.message && data.message.substring(0, 100)}
                        {data.message && data.message.length > 100 && '...'}
                    </div>
                    <ReactFlow.Handle type="target" position="top" />
                    <ReactFlow.Handle type="source" position="bottom" />
                </div>
            );
        };

        // Componente de n√≥ customizado para op√ß√µes
        const OptionsNode = ({ data, id }) => {
            return (
                <div className="custom-node">
                    <div className="node-header">
                        <span className="node-icon">üîò</span>
                        {data.label}
                    </div>
                    <div className="node-content">
                        {data.options && data.options.map((option, index) => (
                            <div key={index} className="option-item">
                                {option.text}
                            </div>
                        ))}
                    </div>
                    <ReactFlow.Handle type="target" position="top" />
                    {data.options && data.options.map((option, index) => (
                        <ReactFlow.Handle 
                            key={option.id}
                            type="source" 
                            position="bottom" 
                            id={option.id}
                            style={{ left: `${20 + (index * 30)}px` }}
                        />
                    ))}
                </div>
            );
        };

        // Componente de n√≥ de in√≠cio
        const StartNode = ({ data, id }) => {
            return (
                <div className="custom-node" style={{ background: 'linear-gradient(135deg, #4CAF50, #45a049)' }}>
                    <div className="node-header" style={{ color: 'white' }}>
                        <span className="node-icon">üöÄ</span>
                        In√≠cio
                    </div>
                    <div className="node-content" style={{ color: 'white' }}>
                        {data.message && data.message.substring(0, 50)}...
                    </div>
                    <ReactFlow.Handle type="source" position="bottom" />
                </div>
            );
        };

        const nodeTypes = {
            message: MessageNode,
            options: OptionsNode,
            start: StartNode
        };

        // Dados iniciais dos n√≥s
        const initialNodes = [
            {
                id: 'start',
                type: 'start',
                position: { x: 250, y: 50 },
                data: {
                    label: 'In√≠cio da Conversa',
                    message: 'Oi! Sou o Astro, seu amigo virtual. Como voc√™ est√° se sentindo hoje?'
                }
            },
            {
                id: 'options-1',
                type: 'options',
                position: { x: 250, y: 200 },
                data: {
                    label: 'Op√ß√µes Iniciais',
                    options: [
                        { id: 'opt1', text: 'N√£o estou bem', value: 'nao_bem' },
                        { id: 'opt2', text: 'Estou confuso', value: 'confuso' },
                        { id: 'opt3', text: 'Aconteceu algo', value: 'aconteceu_algo' }
                    ]
                }
            }
        ];

        const initialEdges = [
            {
                id: 'e1',
                source: 'start',
                target: 'options-1',
                type: 'smoothstep'
            }
        ];

        // Componente principal
        const FlowBuilder = () => {
            const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);
            const [edges, setEdges, onEdgesChange] = useEdgesState(initialEdges);
            const [selectedNode, setSelectedNode] = useState(null);
            const [nodeCounter, setNodeCounter] = useState(3);

            const onConnect = useCallback((params) => {
                setEdges((eds) => addEdge(params, eds));
            }, [setEdges]);

            const onNodeClick = useCallback((event, node) => {
                setSelectedNode(node);
            }, []);

            const addNewNode = (nodeType) => {
                const newNode = {
                    id: `node-${nodeCounter}`,
                    type: nodeType,
                    position: { x: Math.random() * 400, y: Math.random() * 400 + 300 },
                    data: {
                        label: `Novo ${nodeType === 'message' ? 'Mensagem' : 'Op√ß√µes'}`,
                        message: nodeType === 'message' ? 'Nova mensagem do Astro...' : undefined,
                        options: nodeType === 'options' ? [
                            { id: 'opt1', text: 'Op√ß√£o 1', value: 'opcao1' },
                            { id: 'opt2', text: 'Op√ß√£o 2', value: 'opcao2' }
                        ] : undefined
                    }
                };

                setNodes((nds) => nds.concat(newNode));
                setNodeCounter(prev => prev + 1);
            };

            const updateNodeData = (nodeId, newData) => {
                setNodes((nds) =>
                    nds.map((node) =>
                        node.id === nodeId ? { ...node, data: { ...node.data, ...newData } } : node
                    )
                );
            };

            const saveFlow = async () => {
                const flowData = {
                    nodes,
                    edges,
                    metadata: {
                        name: 'Fluxo Terap√™utico',
                        lastModified: new Date().toISOString()
                    }
                };

                try {
                    const response = await fetch('/api/admin/fluxo-visual', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(flowData)
                    });

                    if (response.ok) {
                        alert('‚úÖ Fluxo salvo com sucesso!');
                    } else {
                        alert('‚ùå Erro ao salvar fluxo');
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error.message);
                }
            };

            return (
                <div className="app-container">
                    <div className="sidebar">
                        <div className="stats-panel">
                            <h3>üìä Estat√≠sticas</h3>
                            <div className="stat-item">
                                <span>N√≥s:</span>
                                <span>{nodes.length}</span>
                            </div>
                            <div className="stat-item">
                                <span>Conex√µes:</span>
                                <span>{edges.length}</span>
                            </div>
                        </div>

                        <div className="node-palette">
                            <h3 className="palette-title">üß© Componentes</h3>
                            
                            <div 
                                className="node-item"
                                onClick={() => addNewNode('message')}
                            >
                                <span className="node-icon">üí¨</span>
                                <div>
                                    <div>Mensagem</div>
                                    <small>Resposta do Astro</small>
                                </div>
                            </div>

                            <div 
                                className="node-item"
                                onClick={() => addNewNode('options')}
                            >
                                <span className="node-icon">üîò</span>
                                <div>
                                    <div>Op√ß√µes</div>
                                    <small>Bot√µes para crian√ßa</small>
                                </div>
                            </div>
                        </div>

                        {selectedNode && (
                            <div className="properties-panel">
                                <h3>‚öôÔ∏è Propriedades</h3>
                                
                                <div className="form-group">
                                    <label>T√≠tulo:</label>
                                    <input 
                                        type="text"
                                        value={selectedNode.data.label || ''}
                                        onChange={(e) => updateNodeData(selectedNode.id, { label: e.target.value })}
                                    />
                                </div>

                                {selectedNode.type === 'message' && (
                                    <div className="form-group">
                                        <label>Mensagem do Astro:</label>
                                        <textarea 
                                            value={selectedNode.data.message || ''}
                                            onChange={(e) => updateNodeData(selectedNode.id, { message: e.target.value })}
                                            placeholder="Digite a mensagem que o Astro vai enviar..."
                                        />
                                    </div>
                                )}

                                {selectedNode.type === 'options' && (
                                    <div className="form-group">
                                        <label>Op√ß√µes (JSON):</label>
                                        <textarea 
                                            value={JSON.stringify(selectedNode.data.options || [], null, 2)}
                                            onChange={(e) => {
                                                try {
                                                    const options = JSON.parse(e.target.value);
                                                    updateNodeData(selectedNode.id, { options });
                                                } catch (err) {
                                                    // Ignora erros de JSON inv√°lido durante digita√ß√£o
                                                }
                                            }}
                                            placeholder='[{"id": "opt1", "text": "Op√ß√£o 1", "value": "valor1"}]'
                                        />
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    <div className="main-canvas">
                        <div className="header">
                            <div className="logo">
                                üåü Astro Builder
                            </div>
                            <div className="toolbar">
                                <button className="btn btn-secondary" onClick={saveFlow}>
                                    üíæ Salvar
                                </button>
                                <button className="btn btn-primary" onClick={() => window.open('/admin', '_blank')}>
                                    üìä Hist√≥rico
                                </button>
                            </div>
                        </div>

                        <ReactFlow
                            nodes={nodes}
                            edges={edges}
                            onNodesChange={onNodesChange}
                            onEdgesChange={onEdgesChange}
                            onConnect={onConnect}
                            onNodeClick={onNodeClick}
                            nodeTypes={nodeTypes}
                            fitView
                            attributionPosition="bottom-left"
                        >
                            <Background />
                            <Controls />
                            <MiniMap 
                                nodeStrokeColor="#333"
                                nodeColor="#fff"
                                nodeBorderRadius={8}
                            />
                        </ReactFlow>
                    </div>
                </div>
            );
        };

        // Renderizar a aplica√ß√£o
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FlowBuilder />);
    </script>
</body>
</html>
