version: '3.8'

services:
  backend:
    image: node:18-alpine
    working_dir: /app
    environment:
      - NODE_ENV=production
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - sessions_data:/app/data
    networks:
      - wegetnet
    labels:
      - traefik.enable=1
      - traefik.http.routers.astro-backend.rule=Host(`app.saudemental.icu`) && PathPrefix(`/api`)
      - traefik.http.routers.astro-backend.entrypoints=websecure
      - traefik.http.routers.astro-backend.priority=1
      - traefik.http.routers.astro-backend.tls.certresolver=letsencryptresolver
      - traefik.http.routers.astro-backend.service=evolution
      - traefik.http.services.astro-backend.loadbalancer.server.port=8081
      - traefik.http.services.astro-backend.loadbalancer.passHostHeader=true
    command: >
      sh -c "
        echo 'Baixando código do GitHub...' &&
        apk add --no-cache git &&
        git clone https://github.com/gabossantos-droid/astromental.git /tmp/repo &&
        cp -r /tmp/repo/backend/* /app/ &&
        echo 'Instalando dependências...' &&
        npm install &&
        echo 'Iniciando servidor...' &&
        node server.js
      "
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  frontend:
    image: nginx:alpine
    networks:
      - wegetnet
    depends_on:
      - backend
    labels:
      - traefik.enable=1
      - traefik.http.routers.astro-frontend.rule=Host(`app.saudemental.icu`)
      - traefik.http.routers.astro-frontend.entrypoints=websecure
      - traefik.http.routers.astro-frontend.priority=1
      - traefik.http.routers.astro-frontend.tls.certresolver=letsencryptresolver
      - traefik.http.routers.astro-frontend.service=evolution
      - traefik.http.services.astro-frontend.loadbalancer.server.port=80
      - traefik.http.services.astro-frontend.loadbalancer.passHostHeader=true
    volumes:
      - frontend_data:/usr/share/nginx/html
    command: >
      sh -c "
        echo 'Baixando código do GitHub...' &&
        apk add --no-cache git nodejs npm &&
        git clone https://github.com/gabossantos-droid/astromental.git /tmp/repo &&
        cd /tmp/repo/frontend &&
        echo 'Instalando dependências...' &&
        npm install &&
        echo 'Fazendo build...' &&
        npm run build &&
        echo 'Copiando arquivos...' &&
        cp -r build/* /usr/share/nginx/html/ &&
        echo 'Configurando nginx...' &&
        cp nginx.conf /etc/nginx/conf.d/default.conf &&
        echo 'Iniciando nginx...' &&
        nginx -g 'daemon off;'
      "
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

volumes:
  sessions_data:
    driver: local
  frontend_data:
    driver: local

networks:
  wegetnet:
    external: true
